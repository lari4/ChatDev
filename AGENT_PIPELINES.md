# ChatDev Agent Pipelines Documentation

Этот документ описывает все возможные схемы работы агентов в ChatDev - как организованы пайплайны, какие промты вызываются, как передаются данные между фазами.

## Оглавление

1. [Общая архитектура](#общая-архитектура)
2. [Типы фаз](#типы-фаз)
3. [Основной пайплайн разработки (Default)](#основной-пайплайн-разработки-default)
4. [Пайплайны отдельных фаз](#пайплайны-отдельных-фаз)

---

## Общая архитектура

ChatDev использует архитектуру, основанную на **цепочке фаз** (Chain of Phases), где каждая фаза выполняет определенную задачу в процессе разработки ПО.

### Основные компоненты:

```
┌─────────────────────────────────────────────────────────────┐
│                       ChatChain                              │
│  (Главный оркестратор всего процесса разработки)            │
└────────────────────┬────────────────────────────────────────┘
                     │
                     │ управляет
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                      ChatEnv                                 │
│  (Глобальное окружение с состоянием: код, модальность, и тд)│
└────────────────────┬────────────────────────────────────────┘
                     │
                     │ проходит через
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                   Phase Chain                                │
│  (Последовательность фаз из ChatChainConfig.json)           │
│                                                              │
│  Phase 1 → Phase 2 → ... → Phase N                          │
└─────────────────────────────────────────────────────────────┘
```

### Передача данных между фазами:

```
ChatEnv (Глобальное состояние)
├── task_prompt          (Задача пользователя)
├── modality             (Тип продукта: Application, Website, etc)
├── language             (Язык программирования: Python, Java, etc)
├── ideas                (Креативные идеи для реализации)
├── codes                (Исходный код проекта)
├── comments             (Комментарии от Code Reviewer)
├── test_reports         (Отчеты о тестировании)
├── error_summary        (Резюме ошибок)
├── images               (Описания графических элементов)
├── requirements         (Зависимости проекта)
└── ... (другие данные)

Каждая фаза:
1. Читает необходимые данные из ChatEnv
2. Выполняет диалог между агентами с использованием промтов
3. Записывает результаты обратно в ChatEnv
4. Передает управление следующей фазе
```

---

## Типы фаз

ChatDev поддерживает два типа фаз:

### 1. SimplePhase (Простая фаза)

Одиночная фаза с диалогом между двумя ролями.

**Структура:**
```
┌──────────────────────────────────────────┐
│           SimplePhase                     │
├──────────────────────────────────────────┤
│                                          │
│  User Role (начинает диалог)            │
│         │                                │
│         │ phase_prompt + placeholders   │
│         ▼                                │
│  Assistant Role (отвечает)              │
│         │                                │
│         │ ответ с решением              │
│         ▼                                │
│  [возможно несколько раундов]           │
│         │                                │
│         ▼                                │
│  Результат → ChatEnv                    │
│                                          │
└──────────────────────────────────────────┘
```

**Параметры:**
- `max_turn_step`: максимальное число раундов диалога (-1 = без ограничения, используется default 10)
- `need_reflect`: требуется ли рефлексия (дополнительная проверка результата)

### 2. ComposedPhase (Составная фаза)

Фаза, состоящая из нескольких SimplePhase, выполняемых в цикле.

**Структура:**
```
┌──────────────────────────────────────────────────┐
│           ComposedPhase                          │
├──────────────────────────────────────────────────┤
│                                                  │
│  Цикл (до cycleNum раз):                        │
│  ┌────────────────────────────────────────┐     │
│  │  Composition[0] (SimplePhase)          │     │
│  │    ▼                                   │     │
│  │  Composition[1] (SimplePhase)          │     │
│  │    ▼                                   │     │
│  │  ...                                   │     │
│  │    ▼                                   │     │
│  │  Composition[n] (SimplePhase)          │     │
│  └────────────────────────────────────────┘     │
│         │                                        │
│         │ Проверка условия выхода               │
│         ▼                                        │
│  [если <INFO> Finished → выход из цикла]        │
│  [иначе → следующая итерация]                   │
│                                                  │
└──────────────────────────────────────────────────┘
```

**Параметры:**
- `cycleNum`: максимальное число итераций цикла
- `Composition`: массив SimplePhase, выполняемых в каждой итерации

**Условие выхода:** Если любая фаза в Composition возвращает `<INFO> Finished`, цикл прерывается.

---

## Основной пайплайн разработки (Default)

Это стандартная цепочка фаз для полного цикла разработки ПО от анализа требований до финальной документации.

**Источник конфигурации:** `CompanyConfig/Default/ChatChainConfig.json`

### Полная схема пайплайна:

```
START (User Task Input)
  │
  ▼
┌─────────────────────────────────────────────────────────────┐
│ 1. DemandAnalysis (SimplePhase)                             │
│    CPO ↔ CEO: определяют модальность продукта               │
│    Вход: {task}                                              │
│    Выход: modality → ChatEnv                                 │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. LanguageChoose (SimplePhase)                             │
│    CTO ↔ CEO: выбирают язык программирования                │
│    Вход: {task}, {modality}, {ideas}                        │
│    Выход: language → ChatEnv                                 │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. Coding (SimplePhase)                                     │
│    Programmer ↔ CTO: создают исходный код                   │
│    Вход: {task}, {modality}, {language}, {ideas}            │
│    Выход: codes → ChatEnv                                    │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. CodeCompleteAll (ComposedPhase, cycleNum=10)            │
│    ┌────────────────────────────────────────────┐           │
│    │ 4.1 CodeComplete (SimplePhase)              │           │
│    │     Programmer ↔ CTO: завершают классы      │           │
│    │     Вход: {codes}, {unimplemented_file}     │           │
│    │     Выход: обновленный codes → ChatEnv       │           │
│    └────────────────────────────────────────────┘           │
│    [Цикл до 10 раз, пока все классы не завершены]           │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 5. CodeReview (ComposedPhase, cycleNum=3)                  │
│    ┌────────────────────────────────────────────┐           │
│    │ 5.1 CodeReviewComment (SimplePhase)         │           │
│    │     Code Reviewer ↔ Programmer              │           │
│    │     Вход: {codes}, {task}, {modality}       │           │
│    │     Выход: comments → ChatEnv                │           │
│    │             ▼                                │           │
│    │ 5.2 CodeReviewModification (SimplePhase)    │           │
│    │     Programmer ↔ Code Reviewer              │           │
│    │     Вход: {codes}, {comments}               │           │
│    │     Выход: исправленный codes → ChatEnv      │           │
│    └────────────────────────────────────────────┘           │
│    [Цикл до 3 раз, пока код не идеален]                     │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 6. Test (ComposedPhase, cycleNum=3)                        │
│    ┌────────────────────────────────────────────┐           │
│    │ 6.1 TestErrorSummary (SimplePhase)          │           │
│    │     Programmer ↔ Test Engineer              │           │
│    │     Вход: {codes}, {test_reports}           │           │
│    │     Выход: error_summary → ChatEnv           │           │
│    │             ▼                                │           │
│    │ 6.2 TestModification (SimplePhase)          │           │
│    │     Programmer ↔ Test Engineer              │           │
│    │     Вход: {codes}, {error_summary}          │           │
│    │     Выход: исправленный codes → ChatEnv      │           │
│    └────────────────────────────────────────────┘           │
│    [Цикл до 3 раз, пока все тесты не проходят]              │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 7. EnvironmentDoc (SimplePhase)                            │
│    Programmer ↔ CTO: создают requirements.txt               │
│    Вход: {codes}, {task}                                    │
│    Выход: requirements → ChatEnv                             │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 8. Manual (SimplePhase)                                     │
│    CPO ↔ CEO: создают руководство пользователя             │
│    Вход: {codes}, {requirements}, {task}                    │
│    Выход: manual.md → файловая система                       │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
                     END
              (Готовый проект)
```

### Поток данных по фазам:

| Фаза | Вход (из ChatEnv) | Выход (в ChatEnv) | Промт | Роли |
|------|------------------|------------------|-------|------|
| **DemandAnalysis** | task | modality | Выбор формы продукта | CPO ↔ CEO |
| **LanguageChoose** | task, modality, ideas | language | Выбор языка | CTO ↔ CEO |
| **Coding** | task, modality, language, ideas | codes | Создание кода | Programmer ↔ CTO |
| **CodeComplete** | codes, unimplemented_file | обновленный codes | Завершение классов | Programmer ↔ CTO |
| **CodeReviewComment** | codes, task, modality | comments | Проверка кода | Code Reviewer ↔ Programmer |
| **CodeReviewModification** | codes, comments | исправленный codes | Исправление по ревью | Programmer ↔ Code Reviewer |
| **TestErrorSummary** | codes, test_reports | error_summary | Анализ ошибок | Programmer ↔ Test Engineer |
| **TestModification** | codes, error_summary | исправленный codes | Исправление ошибок | Programmer ↔ Test Engineer |
| **EnvironmentDoc** | codes, task | requirements | requirements.txt | Programmer ↔ CTO |
| **Manual** | codes, requirements, task | manual.md | Руководство | CPO ↔ CEO |

### Особенности пайплайна:

1. **Итеративная разработка:** Фазы CodeReview и Test выполняются в циклах до достижения качества
2. **Накопление контекста:** Каждая фаза обогащает ChatEnv новыми данными
3. **Условный выход:** ComposedPhase завершаются при получении `<INFO> Finished`
4. **Последовательность:** Фазы строго упорядочены - следующая зависит от результатов предыдущей

---
