# ChatDev Agent Pipelines Documentation

Этот документ описывает все возможные схемы работы агентов в ChatDev - как организованы пайплайны, какие промты вызываются, как передаются данные между фазами.

## Оглавление

1. [Общая архитектура](#общая-архитектура)
2. [Типы фаз](#типы-фаз)
3. [Основной пайплайн разработки (Default)](#основной-пайплайн-разработки-default)
4. [Пайплайны отдельных фаз](#пайплайны-отдельных-фаз)

---

## Общая архитектура

ChatDev использует архитектуру, основанную на **цепочке фаз** (Chain of Phases), где каждая фаза выполняет определенную задачу в процессе разработки ПО.

### Основные компоненты:

```
┌─────────────────────────────────────────────────────────────┐
│                       ChatChain                              │
│  (Главный оркестратор всего процесса разработки)            │
└────────────────────┬────────────────────────────────────────┘
                     │
                     │ управляет
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                      ChatEnv                                 │
│  (Глобальное окружение с состоянием: код, модальность, и тд)│
└────────────────────┬────────────────────────────────────────┘
                     │
                     │ проходит через
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                   Phase Chain                                │
│  (Последовательность фаз из ChatChainConfig.json)           │
│                                                              │
│  Phase 1 → Phase 2 → ... → Phase N                          │
└─────────────────────────────────────────────────────────────┘
```

### Передача данных между фазами:

```
ChatEnv (Глобальное состояние)
├── task_prompt          (Задача пользователя)
├── modality             (Тип продукта: Application, Website, etc)
├── language             (Язык программирования: Python, Java, etc)
├── ideas                (Креативные идеи для реализации)
├── codes                (Исходный код проекта)
├── comments             (Комментарии от Code Reviewer)
├── test_reports         (Отчеты о тестировании)
├── error_summary        (Резюме ошибок)
├── images               (Описания графических элементов)
├── requirements         (Зависимости проекта)
└── ... (другие данные)

Каждая фаза:
1. Читает необходимые данные из ChatEnv
2. Выполняет диалог между агентами с использованием промтов
3. Записывает результаты обратно в ChatEnv
4. Передает управление следующей фазе
```

---

## Типы фаз

ChatDev поддерживает два типа фаз:

### 1. SimplePhase (Простая фаза)

Одиночная фаза с диалогом между двумя ролями.

**Структура:**
```
┌──────────────────────────────────────────┐
│           SimplePhase                     │
├──────────────────────────────────────────┤
│                                          │
│  User Role (начинает диалог)            │
│         │                                │
│         │ phase_prompt + placeholders   │
│         ▼                                │
│  Assistant Role (отвечает)              │
│         │                                │
│         │ ответ с решением              │
│         ▼                                │
│  [возможно несколько раундов]           │
│         │                                │
│         ▼                                │
│  Результат → ChatEnv                    │
│                                          │
└──────────────────────────────────────────┘
```

**Параметры:**
- `max_turn_step`: максимальное число раундов диалога (-1 = без ограничения, используется default 10)
- `need_reflect`: требуется ли рефлексия (дополнительная проверка результата)

### 2. ComposedPhase (Составная фаза)

Фаза, состоящая из нескольких SimplePhase, выполняемых в цикле.

**Структура:**
```
┌──────────────────────────────────────────────────┐
│           ComposedPhase                          │
├──────────────────────────────────────────────────┤
│                                                  │
│  Цикл (до cycleNum раз):                        │
│  ┌────────────────────────────────────────┐     │
│  │  Composition[0] (SimplePhase)          │     │
│  │    ▼                                   │     │
│  │  Composition[1] (SimplePhase)          │     │
│  │    ▼                                   │     │
│  │  ...                                   │     │
│  │    ▼                                   │     │
│  │  Composition[n] (SimplePhase)          │     │
│  └────────────────────────────────────────┘     │
│         │                                        │
│         │ Проверка условия выхода               │
│         ▼                                        │
│  [если <INFO> Finished → выход из цикла]        │
│  [иначе → следующая итерация]                   │
│                                                  │
└──────────────────────────────────────────────────┘
```

**Параметры:**
- `cycleNum`: максимальное число итераций цикла
- `Composition`: массив SimplePhase, выполняемых в каждой итерации

**Условие выхода:** Если любая фаза в Composition возвращает `<INFO> Finished`, цикл прерывается.

---

## Основной пайплайн разработки (Default)

Это стандартная цепочка фаз для полного цикла разработки ПО от анализа требований до финальной документации.

**Источник конфигурации:** `CompanyConfig/Default/ChatChainConfig.json`

### Полная схема пайплайна:

```
START (User Task Input)
  │
  ▼
┌─────────────────────────────────────────────────────────────┐
│ 1. DemandAnalysis (SimplePhase)                             │
│    CPO ↔ CEO: определяют модальность продукта               │
│    Вход: {task}                                              │
│    Выход: modality → ChatEnv                                 │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. LanguageChoose (SimplePhase)                             │
│    CTO ↔ CEO: выбирают язык программирования                │
│    Вход: {task}, {modality}, {ideas}                        │
│    Выход: language → ChatEnv                                 │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. Coding (SimplePhase)                                     │
│    Programmer ↔ CTO: создают исходный код                   │
│    Вход: {task}, {modality}, {language}, {ideas}            │
│    Выход: codes → ChatEnv                                    │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. CodeCompleteAll (ComposedPhase, cycleNum=10)            │
│    ┌────────────────────────────────────────────┐           │
│    │ 4.1 CodeComplete (SimplePhase)              │           │
│    │     Programmer ↔ CTO: завершают классы      │           │
│    │     Вход: {codes}, {unimplemented_file}     │           │
│    │     Выход: обновленный codes → ChatEnv       │           │
│    └────────────────────────────────────────────┘           │
│    [Цикл до 10 раз, пока все классы не завершены]           │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 5. CodeReview (ComposedPhase, cycleNum=3)                  │
│    ┌────────────────────────────────────────────┐           │
│    │ 5.1 CodeReviewComment (SimplePhase)         │           │
│    │     Code Reviewer ↔ Programmer              │           │
│    │     Вход: {codes}, {task}, {modality}       │           │
│    │     Выход: comments → ChatEnv                │           │
│    │             ▼                                │           │
│    │ 5.2 CodeReviewModification (SimplePhase)    │           │
│    │     Programmer ↔ Code Reviewer              │           │
│    │     Вход: {codes}, {comments}               │           │
│    │     Выход: исправленный codes → ChatEnv      │           │
│    └────────────────────────────────────────────┘           │
│    [Цикл до 3 раз, пока код не идеален]                     │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 6. Test (ComposedPhase, cycleNum=3)                        │
│    ┌────────────────────────────────────────────┐           │
│    │ 6.1 TestErrorSummary (SimplePhase)          │           │
│    │     Programmer ↔ Test Engineer              │           │
│    │     Вход: {codes}, {test_reports}           │           │
│    │     Выход: error_summary → ChatEnv           │           │
│    │             ▼                                │           │
│    │ 6.2 TestModification (SimplePhase)          │           │
│    │     Programmer ↔ Test Engineer              │           │
│    │     Вход: {codes}, {error_summary}          │           │
│    │     Выход: исправленный codes → ChatEnv      │           │
│    └────────────────────────────────────────────┘           │
│    [Цикл до 3 раз, пока все тесты не проходят]              │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 7. EnvironmentDoc (SimplePhase)                            │
│    Programmer ↔ CTO: создают requirements.txt               │
│    Вход: {codes}, {task}                                    │
│    Выход: requirements → ChatEnv                             │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 8. Manual (SimplePhase)                                     │
│    CPO ↔ CEO: создают руководство пользователя             │
│    Вход: {codes}, {requirements}, {task}                    │
│    Выход: manual.md → файловая система                       │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
                     END
              (Готовый проект)
```

### Поток данных по фазам:

| Фаза | Вход (из ChatEnv) | Выход (в ChatEnv) | Промт | Роли |
|------|------------------|------------------|-------|------|
| **DemandAnalysis** | task | modality | Выбор формы продукта | CPO ↔ CEO |
| **LanguageChoose** | task, modality, ideas | language | Выбор языка | CTO ↔ CEO |
| **Coding** | task, modality, language, ideas | codes | Создание кода | Programmer ↔ CTO |
| **CodeComplete** | codes, unimplemented_file | обновленный codes | Завершение классов | Programmer ↔ CTO |
| **CodeReviewComment** | codes, task, modality | comments | Проверка кода | Code Reviewer ↔ Programmer |
| **CodeReviewModification** | codes, comments | исправленный codes | Исправление по ревью | Programmer ↔ Code Reviewer |
| **TestErrorSummary** | codes, test_reports | error_summary | Анализ ошибок | Programmer ↔ Test Engineer |
| **TestModification** | codes, error_summary | исправленный codes | Исправление ошибок | Programmer ↔ Test Engineer |
| **EnvironmentDoc** | codes, task | requirements | requirements.txt | Programmer ↔ CTO |
| **Manual** | codes, requirements, task | manual.md | Руководство | CPO ↔ CEO |

### Особенности пайплайна:

1. **Итеративная разработка:** Фазы CodeReview и Test выполняются в циклах до достижения качества
2. **Накопление контекста:** Каждая фаза обогащает ChatEnv новыми данными
3. **Условный выход:** ComposedPhase завершаются при получении `<INFO> Finished`
4. **Последовательность:** Фазы строго упорядочены - следующая зависит от результатов предыдущей

---

## Пайплайны отдельных фаз

Детальное описание работы каждой фазы с диаграммами взаимодействия агентов.

### 1. Пайплайн DemandAnalysis

**Тип:** SimplePhase
**Цель:** Определить модальность продукта (Application, Website, PDF и т.д.)

**Схема взаимодействия:**

```
┌─────────────────────────────────────────────────────────────┐
│                    DemandAnalysis Phase                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ChatEnv:                                                    │
│  ├─ task_prompt: "Создать калькулятор"                      │
│  └─ (другие данные...)                                       │
│                                                              │
│  ┌────────────────────────────────────────────┐             │
│  │  User Role: CEO                             │             │
│  │  (Chief Executive Officer)                  │             │
│  └──────────────────┬──────────────────────────┘             │
│                     │                                        │
│                     │ Отправляет phase_prompt:              │
│                     │ "Какой тип продукта выбрать?"          │
│                     │                                        │
│                     ▼                                        │
│  ┌────────────────────────────────────────────┐             │
│  │  Assistant Role: CPO                        │             │
│  │  (Chief Product Officer)                    │             │
│  │                                             │             │
│  │  Анализирует:                               │             │
│  │  - Варианты: Image, Document, PowerPoint,  │             │
│  │    Excel, PDF, Website, Application, etc   │             │
│  │  - Требования задачи                        │             │
│  └──────────────────┬──────────────────────────┘             │
│                     │                                        │
│                     │ Предлагает варианты                   │
│                     ▼                                        │
│  ┌────────────────────────────────────────────┐             │
│  │  Диалог (несколько раундов):               │             │
│  │  CEO: "Нужно что-то интерактивное"         │             │
│  │  CPO: "Предлагаю Application"               │             │
│  │  CEO: "Согласен"                            │             │
│  │  CPO: "<INFO> Application"                  │             │
│  └──────────────────┬──────────────────────────┘             │
│                     │                                        │
│                     │ Извлекается modality                  │
│                     ▼                                        │
│  ChatEnv обновляется:                                        │
│  ├─ modality: "Application"                                  │
│  └─ ...                                                      │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**Поток данных:**

```
Вход → Обработка → Выход
{task} → [Диалог CEO ↔ CPO] → modality
                  ↓
          (Промт с вариантами модальностей)
                  ↓
          (Обсуждение и выбор)
                  ↓
          (Финальное решение: <INFO> Modality)
```

**Ключевые моменты:**
- Диалог продолжается до единогласного решения
- Финальный ответ должен быть в формате `<INFO> [Modality]`
- `need_reflect = True` - результат проверяется дополнительно

---

### 2. Пайплайн Coding

**Тип:** SimplePhase
**Цель:** Создать полный исходный код приложения

**Схема взаимодействия:**

```
┌─────────────────────────────────────────────────────────────┐
│                      Coding Phase                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ChatEnv:                                                    │
│  ├─ task: "Создать калькулятор"                             │
│  ├─ modality: "Application"                                  │
│  ├─ language: "Python"                                       │
│  └─ ideas: "Использовать Tkinter для GUI"                   │
│                                                              │
│  ┌────────────────────────────────────────────┐             │
│  │  User Role: CTO                             │             │
│  │  (Chief Technology Officer)                 │             │
│  └──────────────────┬──────────────────────────┘             │
│                     │                                        │
│                     │ Отправляет phase_prompt с контекстом: │
│                     │ - Описание задачи                      │
│                     │ - Выбранный язык (Python)              │
│                     │ - Требования к архитектуре             │
│                     │                                        │
│                     ▼                                        │
│  ┌────────────────────────────────────────────┐             │
│  │  Assistant Role: Programmer                 │             │
│  │                                             │             │
│  │  Процесс разработки:                        │             │
│  │  1. Планирует архитектуру:                 │             │
│  │     - Определяет классы                     │             │
│  │     - Определяет функции                    │             │
│  │     - Комментирует назначение               │             │
│  │                                             │             │
│  │  2. Пишет код файлов:                       │             │
│  │     - main.py (основной файл)               │             │
│  │     - calculator.py (логика калькулятора)   │             │
│  │     - gui.py (интерфейс)                    │             │
│  │                                             │             │
│  │  3. Форматирует в Markdown:                 │             │
│  │     ```python                               │             │
│  │     '''                                     │             │
│  │     DOCSTRING                               │             │
│  │     '''                                     │             │
│  │     CODE                                    │             │
│  │     ```                                     │             │
│  └──────────────────┬──────────────────────────┘             │
│                     │                                        │
│                     │ Возвращает полный код                 │
│                     ▼                                        │
│  ChatEnv обновляется:                                        │
│  ├─ codes: {                                                 │
│  │    "main.py": "код...",                                  │
│  │    "calculator.py": "код...",                            │
│  │    "gui.py": "код..."                                    │
│  │  }                                                        │
│  └─ ...                                                      │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**Поток данных:**

```
Вход → Обработка → Выход
{task, modality, language, ideas}
       ↓
[Programmer планирует архитектуру]
       ↓
[Programmer пишет код всех файлов]
       ↓
[Форматирование в Markdown]
       ↓
codes (dict of filename → code)
```

**Важные требования:**
- Код должен быть полностью функциональным
- Запрещены заглушки (placeholders)
- Начинать с main файла, затем импортированные модули
- `max_turn_step = 1` - один раунд диалога (без обсуждения)

---

### 3. Пайплайн CodeReview (ComposedPhase)

**Тип:** ComposedPhase (cycleNum = 3)
**Цель:** Итеративная проверка и улучшение качества кода
**Состав:** CodeReviewComment → CodeReviewModification

**Схема взаимодействия:**

```
┌─────────────────────────────────────────────────────────────┐
│                 CodeReview ComposedPhase                     │
│                    (до 3 итераций)                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Итерация 1:                                                 │
│  ┌────────────────────────────────────────────┐             │
│  │  SimplePhase: CodeReviewComment            │             │
│  │                                             │             │
│  │  ChatEnv:                                   │             │
│  │  ├─ codes: {текущий код}                   │             │
│  │  ├─ task: "Создать калькулятор"            │             │
│  │  └─ modality: "Application"                 │             │
│  │                                             │             │
│  │  User: Programmer                           │             │
│  │  Assistant: Code Reviewer                   │             │
│  │                                             │             │
│  │  Code Reviewer проверяет по 6 критериям:  │             │
│  │  1. ✓ Все классы импортированы             │             │
│  │  2. ✗ Метод calculate() не реализован      │             │
│  │  3. ✓ Комментарии есть                     │             │
│  │  4. ✓ Нет явных багов                      │             │
│  │  5. ✓ Соответствует требованиям            │             │
│  │  6. ✓ Логика корректна                     │             │
│  │                                             │             │
│  │  Выход:                                     │             │
│  │  comments: "Метод calculate() должен быть  │             │
│  │             полностью реализован..."        │             │
│  └──────────────────┬──────────────────────────┘             │
│                     │                                        │
│                     ▼                                        │
│  ┌────────────────────────────────────────────┐             │
│  │  SimplePhase: CodeReviewModification       │             │
│  │                                             │             │
│  │  ChatEnv:                                   │             │
│  │  ├─ codes: {текущий код}                   │             │
│  │  └─ comments: {комментарии от ревьюера}    │             │
│  │                                             │             │
│  │  User: Code Reviewer                        │             │
│  │  Assistant: Programmer                      │             │
│  │                                             │             │
│  │  Programmer:                                │             │
│  │  - Читает комментарии                      │             │
│  │  - Исправляет код                          │             │
│  │  - Возвращает обновленный код              │             │
│  │                                             │             │
│  │  Выход:                                     │             │
│  │  codes: {исправленный код}                 │             │
│  └──────────────────┬──────────────────────────┘             │
│                     │                                        │
│                     ▼                                        │
│  ChatEnv обновляется с новым кодом                          │
│                                                              │
│  ─────────────── Итерация 2 ──────────────────              │
│  (Повторяется аналогично)                                   │
│                                                              │
│  Если Code Reviewer возвращает:                             │
│  "<INFO> Finished" → Выход из цикла                         │
│                                                              │
│  ─────────────── Итерация 3 ──────────────────              │
│  (Последняя возможная итерация)                             │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**Детальный поток данных:**

```
Начало CodeReview ComposedPhase
│
├─ Итерация 1:
│  │
│  ├─ CodeReviewComment:
│  │  Вход: codes, task, modality, language, ideas
│  │  Процесс:
│  │    1. Code Reviewer получает все коды
│  │    2. Проверяет по чек-листу из 6 пунктов
│  │    3. Находит проблему с наивысшим приоритетом
│  │  Выход:
│  │    - comments: "Описание проблемы + инструкция"
│  │    - ИЛИ "<INFO> Finished" (если код идеален)
│  │
│  └─ CodeReviewModification:
│     Вход: codes, comments, task, modality
│     Процесс:
│       1. Programmer читает comments
│       2. Вносит исправления в код
│       3. Возвращает полный обновленный код
│     Выход:
│       - codes: {обновленные файлы}
│
├─ Итерация 2:
│  (Повторяется с новым codes)
│
├─ Итерация 3:
│  (Финальная итерация, если нужна)
│
└─ Конец (максимум 3 итерации ИЛИ раньше если "<INFO> Finished")
```

**Условия выхода:**

1. **Успешное завершение:** Code Reviewer возвращает `<INFO> Finished`
2. **Достижение лимита:** Выполнено 3 итерации (cycleNum = 3)

**Критерии проверки Code Reviewer:**

| № | Критерий | Проверка |
|---|----------|----------|
| 1 | Импорты | Все используемые классы импортированы |
| 2 | Реализация | Все методы полностью реализованы (нет заглушек) |
| 3 | Документация | Все методы имеют необходимые комментарии |
| 4 | Баги | Нет потенциальных ошибок |
| 5 | Требования | Проект соответствует задаче пользователя |
| 6 | Логика | Пользователь может использовать без потери функционала |

**Особенности:**
- Один комментарий за раз (наивысший приоритет)
- Полная переписка кода на каждой итерации
- `max_turn_step = 1` для обеих фаз (без дискуссий)

---

### 4. Пайплайн Test (ComposedPhase)

**Тип:** ComposedPhase (cycleNum = 3)
**Цель:** Итеративное тестирование и исправление ошибок
**Состав:** TestErrorSummary → TestModification

**Схема взаимодействия:**

```
┌─────────────────────────────────────────────────────────────┐
│                   Test ComposedPhase                         │
│                    (до 3 итераций)                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  [Система выполняет тесты → test_reports]                   │
│                                                              │
│  Итерация 1:                                                 │
│  ┌────────────────────────────────────────────┐             │
│  │  SimplePhase: TestErrorSummary              │             │
│  │                                             │             │
│  │  ChatEnv:                                   │             │
│  │  ├─ codes: {текущий код}                   │             │
│  │  └─ test_reports: {отчеты об ошибках}     │             │
│  │                                             │             │
│  │  User: Test Engineer                        │             │
│  │  Assistant: Programmer                      │             │
│  │                                             │             │
│  │  Test Engineer:                             │             │
│  │  "Вот отчеты о тестировании"                │             │
│  │                                             │             │
│  │  Programmer анализирует:                    │             │
│  │  - TypeError в line 42 main.py              │             │
│  │  - IndexError в line 15 calculator.py       │             │
│  │  - KeyError в line 89 gui.py                │             │
│  │                                             │             │
│  │  Выход:                                     │             │
│  │  error_summary: "3 ошибки обнаружены:      │             │
│  │    1. TypeError: неправильный тип аргумента│             │
│  │    2. IndexError: выход за границы массива │             │
│  │    3. KeyError: несуществующий ключ"       │             │
│  └──────────────────┬──────────────────────────┘             │
│                     │                                        │
│                     ▼                                        │
│  ┌────────────────────────────────────────────┐             │
│  │  SimplePhase: TestModification              │             │
│  │                                             │             │
│  │  ChatEnv:                                   │             │
│  │  ├─ codes: {текущий код}                   │             │
│  │  ├─ test_reports: {отчеты}                 │             │
│  │  └─ error_summary: {резюме ошибок}         │             │
│  │                                             │             │
│  │  User: Test Engineer                        │             │
│  │  Assistant: Programmer                      │             │
│  │                                             │             │
│  │  Programmer:                                │             │
│  │  - Читает error_summary                    │             │
│  │  - Исправляет каждую ошибку                │             │
│  │  - Возвращает исправленный код             │             │
│  │                                             │             │
│  │  Выход:                                     │             │
│  │  codes: {код с исправлениями}              │             │
│  │  ИЛИ "<INFO> Finished" (если багов нет)    │             │
│  └──────────────────┬──────────────────────────┘             │
│                     │                                        │
│                     ▼                                        │
│  [Система снова выполняет тесты]                            │
│                                                              │
│  Итерация 2:                                                 │
│  (Повторяется с новым codes и test_reports)                 │
│                                                              │
│  Если TestModification возвращает:                          │
│  "<INFO> Finished" → Выход из цикла                         │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**Детальный поток данных:**

```
Начало Test ComposedPhase
│
├─ [Внешняя система выполняет тесты]
│  Результат → test_reports в ChatEnv
│
├─ Итерация 1:
│  │
│  ├─ TestErrorSummary:
│  │  Вход: codes, test_reports, language
│  │  Процесс:
│  │    1. Programmer получает test_reports
│  │    2. Анализирует каждую ошибку
│  │    3. Локализует источники проблем
│  │    4. Формирует краткое резюме
│  │  Выход:
│  │    - error_summary: "Список ошибок с описанием"
│  │
│  └─ TestModification:
│     Вход: codes, test_reports, error_summary
│     Процесс:
│       1. Programmer читает error_summary
│       2. Исправляет код для каждой ошибки
│       3. Возвращает полностью исправленный код
│     Выход:
│       - codes: {исправленные файлы}
│       - ИЛИ "<INFO> Finished" (если багов не было)
│
├─ [Повторное тестирование]
│
├─ Итерация 2:
│  (Повторяется если остались ошибки)
│
└─ Конец (максимум 3 итерации ИЛИ "<INFO> Finished")
```

**Условия выхода:**

1. **Успешное завершение:** TestModification возвращает `<INFO> Finished` (нет ошибок)
2. **Достижение лимита:** Выполнено 3 итерации (cycleNum = 3)

**Особенности:**
- Тесты выполняются внешней системой между итерациями
- Запрещены TODO и неполные решения
- Программист должен исправить ВСЕ ошибки из error_summary
- `max_turn_step = 1` для обеих фаз

---

### 5. Пайплайн ArtDesign и ArtIntegration

**Тип:** Две отдельные SimplePhase (не в цикле)
**Цель:** Создание и интеграция графических элементов GUI

**Схема взаимодействия:**

```
┌─────────────────────────────────────────────────────────────┐
│                      ArtDesign Phase                         │
├─────────────────────────────────────────────────────────────┤
│  Programmer ↔ CCO: определяют графические элементы          │
│                                                              │
│  Вход: codes, task, language                                 │
│  Выход: images = [                                           │
│    "button_1.png: Кнопка с цифрой 1",                       │
│    "background.png: Фон приложения",                         │
│    ...                                                       │
│  ]                                                           │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
         [Внешняя система генерирует изображения 256x256]
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                   ArtIntegration Phase                       │
├─────────────────────────────────────────────────────────────┤
│  Programmer ↔ CCO: интегрируют изображения в код            │
│                                                              │
│  Вход: codes, images, task, language                         │
│  Процесс:                                                    │
│    - Программист добавляет код загрузки изображений         │
│    - Применяет динамическое масштабирование                  │
│    - Использует self.* для предотвращения GC                │
│  Выход: обновленный codes с графикой                         │
└─────────────────────────────────────────────────────────────┘
```

---

## Заключение

### Ключевые принципы работы пайплайнов:

1. **Модульность:** Каждая фаза выполняет одну четко определенную задачу
2. **Накопление контекста:** ChatEnv аккумулирует данные через все фазы
3. **Итеративность:** ComposedPhase позволяют многократно улучшать результат
4. **Ясность выхода:** Специальный маркер `<INFO>` сигнализирует о завершении
5. **Разделение ролей:** Каждая роль имеет свою специализацию и зону ответственности

### Типичный жизненный цикл задачи:

```
User Input (task_prompt)
       ↓
[Анализ] → modality, language
       ↓
[Разработка] → codes (v1)
       ↓
[Завершение] → codes (v2, полностью реализованные классы)
       ↓
[Код-ревью] → codes (v3, качественный код) × до 3 раз
       ↓
[Тестирование] → codes (v4, без багов) × до 3 раз
       ↓
[Документация] → requirements.txt, manual.md
       ↓
Final Product (готовое приложение)
```

### Расширяемость:

Система легко расширяется добавлением новых:
- **SimplePhase** - для новых типов задач
- **ComposedPhase** - для сложных многоэтапных процессов
- **Ролей** - для новых специализаций агентов
- **Конфигураций** - для различных workflow (Human, Art, Incremental)

Все пайплайны документированы в:
- **PROMPTS_DOCUMENTATION.md** - все промты системы
- **AGENT_PIPELINES.md** - схемы работы агентов (этот файл)
- Исходные конфигурации в `CompanyConfig/Default/`
